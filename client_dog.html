<!DOCTYPE html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset="utf-8" />

<title>WebSocket Test</title>

<script language="javascript" type="text/javascript">

  //var wsUri = "ws://echo.websocket.org";
  var wsUri = "ws://localhost:8080/dogws";
  var output;

  function init()
  {
    output = document.getElementById("output");
    //testWebSocket();
  }


function replacer(key, value) {
    if (typeof value === 'number' && !isFinite(value)) {
        return String(value);
    }
    return value;
}

  function startWebSocket()
  {
    if (!window.WebSocket)
	{
        	alert("WebSocket not supported by this browser");
		var connessione=document.getElementById("connessione");
		connessione.removeChild(connessione.childNodes[0]);
	}
	else
	{
		wsUri=document.getElementById("URL").value;
		websocket = new WebSocket(wsUri);
		websocket.onopen = function(evt) { onOpen(evt) };
		websocket.onclose = function(evt) { onClose(evt) };
		websocket.onmessage = function(evt) { onMessage(evt) };
		websocket.onerror = function(evt) { onError(evt) };
	}
  }

  function onOpen(evt)
  {

	var stato=document.getElementById("stato");
	stato.removeChild(stato.childNodes[0]);
	var div = document.createElement("div");
	div.setAttribute("id","testo");
	div.innerHTML="CONNECTED";
	stato.appendChild(div);
    writeToScreen("CONNECTED");
    
	aggiungi_pulsante_disconnetti();
  }

function aggiungi_pulsante_disconnetti()
{

	var connetti_new = document.createElement("div");
	connetti_new.setAttribute("id","connetti");
    var input_button_close = document.createElement("input");
	input_button_close.setAttribute("type","submit");
	input_button_close.setAttribute("value","Chiudi connessione");
	input_button_close.setAttribute("onclick","websocket.close()");

	connetti_new.appendChild(input_button_close);


	var br=document.createElement("br");
	
	connetti_new.appendChild(br);
	

	connetti_new.innerHTML += "RESOURCE: ";
	var input = document.createElement("input");
	input.setAttribute("type","text");
	input.setAttribute("name","resource");
	input.setAttribute("id","resource");
	input.setAttribute("value","devices");
	//input.setAttribute("onkeypress","javascript:if(event.keyCode==13) doSend();");
	input.setAttribute("size","15");
	connetti_new.appendChild(input);

	connetti_new.appendChild(br);

	connetti_new.innerHTML += "ID(resource or flat): ";
	input = document.createElement("input");
	input.setAttribute("type","text");
	input.setAttribute("name","id");
	input.setAttribute("id","id");
	//input.setAttribute("value","");
	input.setAttribute("size","15");
	connetti_new.appendChild(input);


	connetti_new.appendChild(br);

	connetti_new.innerHTML += "Room ID: ";
	input = document.createElement("input");
	input.setAttribute("type","text");
	input.setAttribute("name","roomId");
	input.setAttribute("id","roomId");
	//input.setAttribute("value","");
	input.setAttribute("size","15");
	connetti_new.appendChild(input);

	connetti_new.appendChild(br);
	
	connetti_new.innerHTML += "METHOD: ";
	input = document.createElement("input");
	input.setAttribute("type","text");
	input.setAttribute("name","method");
	input.setAttribute("id","method");
	input.setAttribute("value","GET");
	input.setAttribute("size","15");
	connetti_new.appendChild(input);

	connetti_new.appendChild(br);

	connetti_new.innerHTML += "PROPERTY: ";
	input = document.createElement("input");
	input.setAttribute("type","text");
	input.setAttribute("name","property");
	input.setAttribute("id","property");
	input.setAttribute("value","");
	input.setAttribute("size","15");
	connetti_new.appendChild(input);

	connetti_new.appendChild(br);

	connetti_new.innerHTML += "COMMAND: ";
	input = document.createElement("input");
	input.setAttribute("type","text");
	input.setAttribute("name","command");
	input.setAttribute("id","command");
	input.setAttribute("value","");
	input.setAttribute("size","15");
	connetti_new.appendChild(input);

	connetti_new.appendChild(br);

	connetti_new.innerHTML += "FORMAT: ";
	input = document.createElement("input");
	input.setAttribute("type","text");
	input.setAttribute("name","format");
	input.setAttribute("id","format");
	input.setAttribute("value","Json");
	input.setAttribute("size","15");
	connetti_new.appendChild(input);

	connetti_new.appendChild(br);

	connetti_new.innerHTML += "PARAMETERS: ";
	input = document.createElement("input");
	input.setAttribute("type","text");
	input.setAttribute("name","parameters");
	input.setAttribute("id","parameters");
	input.setAttribute("value","");
	input.setAttribute("size","15");
	connetti_new.appendChild(input);

	connetti_new.appendChild(br);
    var input_button = document.createElement("input");
	input_button.setAttribute("type","submit");
	input_button.setAttribute("value","invia");
	input_button.setAttribute("onclick","doSend()");
	connetti_new.appendChild(input_button);
	var connetti=document.getElementById("connessione");
	connetti.removeChild(connetti.childNodes[0]);
	
	var connessione=document.getElementById("connessione");
	connessione.appendChild(connetti_new);

}

function aggiungi_pulsante_connetti()
{
	var connessione=document.getElementById("connessione");

	var connetti_new = document.createElement("div");
	connetti_new.setAttribute("id","connetti");
	var input_button_open = document.createElement("input");
	input_button_open.setAttribute("type","submit");
	input_button_open.setAttribute("value","Apri connessione");
	input_button_open.setAttribute("onclick","startWebSocket()");


	connetti_new.appendChild(input_button_open);

	
	connessione.removeChild(connessione.childNodes[0]);
	connessione.appendChild(connetti_new);
	

}
  function onClose(evt)
  {
	
	var stato=document.getElementById("stato");
	stato.removeChild(stato.childNodes[0]);
	var div = document.createElement("div");
	div.setAttribute("id","testo");
	div.innerHTML="DISCONNECTED";
	stato.appendChild(div);
    writeToScreen("DISCONNECTED");
	aggiungi_pulsante_connetti();
  }

  function onMessage(evt)
  {
    writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>');
    //websocket.close();
  }

  function onError(evt)
  {
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
  }

  function doSend()
  {
	var resource=document.getElementById("resource").value;
	var id=document.getElementById("id").value;
	var property=document.getElementById("property").value;
	var command=document.getElementById("command").value;
	var roomId=document.getElementById("roomId").value;
	var method=document.getElementById("method").value;
	var format=document.getElementById("format").value;
	var parameters=document.getElementById("parameters").value;

	var myJSONObject = {"resource": resource, "id": id, "command": command, "property": property, "roomId": roomId , "method": method, "format": format, "parameters": parameters};
	
	var message = JSON.stringify(myJSONObject, replacer);
    writeToScreen("SENDING: " + message + " ... "); 
	websocket.send(message);
    writeToScreen("SENT: " + message); 
  }

  function writeToScreen(message)
  {
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
  }

  window.addEventListener("load", init, false);

		

</script>
</head>
<body>
<h2>WebSocket Test</h2>
<div id="indirizzo">Indirizzo: <input type="text" id="URL" value="ws://localhost:8080/dogws"/></div>
<div id="stato">DISCONNECTED</div>
<div id="connessione"><div id="connetti"><input onclick="startWebSocket()" value="Apri connessione" type="submit" /></div></div>
<div id="invio"></br/></div>
<div id="output"></div>
</body>
</html> 